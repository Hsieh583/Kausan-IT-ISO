name: ISO 27001 åˆè¦æ€§é©—è­‰

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 8:00 (UTC) åŸ·è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å–å¾—å®Œæ•´çš„ git æ­·å²è¨˜éŒ„
      
      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£ä¾è³´
        run: |
          cd scripts
          pip install -r requirements.txt
      
      - name: åŸ·è¡Œåˆè¦æ€§æƒæ
        id: compliance
        run: |
          cd scripts
          python iso_automation.py compliance-report --output ../compliance_report.md
          
          # æª¢æŸ¥æ˜¯å¦æœ‰å•é¡Œ
          echo "Compliance scan completed"
      
      - name: é¡¯ç¤ºåˆè¦æ€§å ±å‘Š
        run: |
          echo "=== åˆè¦æ€§æƒæå ±å‘Š ==="
          cat compliance_report.md
      
      - name: ä¸Šå‚³åˆè¦æ€§å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report-${{ github.sha }}
          path: compliance_report.md
          retention-days: 90
      
      - name: ç”Ÿæˆæœ¬é€±é€±å ±
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          cd scripts
          LAST_WEEK=$(date -d '7 days ago' +%Y-%m-%d)
          TODAY=$(date +%Y-%m-%d)
          python iso_automation.py weekly-report \
            --since "$LAST_WEEK" \
            --until "$TODAY" \
            --output ../weekly_report.md || echo "No commits found"
      
      - name: ä¸Šå‚³é€±å ±
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_number }}
          path: weekly_report.md
          retention-days: 365
        continue-on-error: true
      
      - name: æª¢æŸ¥è­‰æ“šè¨˜éŒ„å®Œæ•´æ€§
        run: |
          echo "=== æª¢æŸ¥è­‰æ“šè¨˜éŒ„å®Œæ•´æ€§ ==="
          
          # çµ±è¨ˆå„é¡åˆ¥çš„è­‰æ“šè¨˜éŒ„æ•¸é‡
          cd "è¨˜éŒ„èˆ‡è­‰æ“š"
          
          for category in */; do
            if [ -d "$category" ]; then
              category_name=$(basename "$category")
              
              # è·³ééç›®éŒ„é …ç›®
              if [[ "$category_name" == *.md ]]; then
                continue
              fi
              
              # çµ±è¨ˆæ¨¡æ¿æ•¸é‡
              template_count=$(find "$category" -maxdepth 1 -name "*_Template.md" | wc -l)
              
              # çµ±è¨ˆè­‰æ“šè¨˜éŒ„æ•¸é‡
              record_count=$(find "$category" -type f -name "*.md" ! -name "*_Template.md" | wc -l)
              
              echo "ğŸ“ $category_name: $template_count å€‹æ¨¡æ¿, $record_count å€‹è¨˜éŒ„"
            fi
          done
      
      - name: è©•è«– PR (å¦‚æœæ˜¯ PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compliance_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” ISO 27001 åˆè¦æ€§æª¢æŸ¥çµæœ\n\n${report}`
            });
